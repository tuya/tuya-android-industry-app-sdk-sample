## MQTTService

MQTT服务协议，定义了MQTT服务的基本操作。

**方法列表**

- `connect()`：连接MQTT服务
- `disconnect()`：断开MQTT服务连接
- `subscribe(topic: String, callback: IMQTTSubscribeCallback)`：订阅指定主题
- `unsubscribe(topic: String, callback: IMQTTSubscribeCallback)`：取消订阅指定主题

**方法说明**

### `connect()`

连接MQTT服务，该方法无参数。

### `disconnect()`

断开MQTT服务连接，该方法无参数。

### 订阅主题

**参数说明**

| 参数名 | 类型 | 是否必填 | 说明 |
| --- | --- | --- | --- |
| topic | String | 是 | 要订阅的主题 |
| callback | IMQTTSubscribeCallback | 是 | 订阅回调函数 |

**代码示例**

```java
MQTTService.subscribe("topic", new IMQTTSubscribeCallback() {
            @Override
            public void onError(String s, String s1) {
                Log.d(TAG, "onError: " + s);
                
            }

            @Override
            public void onSuccess() {
                Log.d(TAG, "onSuccess: ");

            }
        });
```

## 蓝牙工具

### 连接离线设备

**参数说明**

| 参数名 | 类型 | 是否必填 | 说明 |
| --- | --- | --- | --- |
| beans | List<BleConnectBean> | 是 | 包含BleConnectBean对象的列表 |
| bleConnectBean | BleConnectBean | 是 | 创建一个BleConnectBean对象 |
| devId | String | 是 | 设备ID |
| directConnect | boolean | 是 | 是否直接连接 |
| level | int | 是 | 等级 |
| scanTimeout | int | 是 | 扫描超时时间 |
| autoConnect | boolean | 是 | 是否自动连接 |
| extInfo | ExtInfo | 可选 | 扩展信息 |

**代码示例**

```java
List<BleConnectBean> beans = new ArrayList<>();
BleConnectBean bleConnectBean = new BleConnectBean(
        "your_dev_id", // 设置devId属性
        false, // 设置directConnect属性
        0, // 设置level属性
        30000, // 设置scanTimeout属性
        false, // 设置autoConnect属性
        null // 设置extInfo属性（可选，传入null表示没有extInfo）
);
beans.add(bleConnectBean);
BleToolService.connectBleDevices(beans);
```
### 断开连接设备

**代码示例**

```java
List<BleConnectBean> beans = new ArrayList<>();
BleConnectBean bleConnectBean = new BleConnectBean(
        "your_dev_id", // 设置devId属性
        false, // 设置directConnect属性
        0, // 设置level属性
        30000, // 设置scanTimeout属性
        false, // 设置autoConnect属性
        null // 设置extInfo属性（可选，传入null表示没有extInfo）
);
beans.add(bleConnectBean);
BleToolService.disconnectBleDevices(beans);
```

### 取消订阅主题

**参数说明**

| 参数名 | 类型 | 是否必填 | 说明 |
| --- | --- | --- | --- |
| topic | String | 是 | 要取消订阅的主题 |
| callback | IMQTTSubscribeCallback | 是 | 订阅回调函数 |

**代码示例**

```java
MQTTService.unsubscribe("topic", new IMQTTSubscribeCallback() {
            @Override
            public void onError(String s, String s1) {
                Log.d(TAG, "onError: " + s);
                
            }

            @Override
            public void onSuccess() {
                Log.d(TAG, "onSuccess: ");

            }
        });
```

## 获取设备详情

根据设备ID加载设备对象。

**参数说明**

| 参数名 | 类型 | 是否必填 | 说明 |
| --- | --- | --- | --- |
| deviceId | String | 是 | 设备ID |

**返回IDevice对象说明**

| 参数名 | 类型 | 说明 |
| --- | --- | --- |
| getDeviceId() | String | 设备ID |
| getUUID() | String | 设备UUID |
| getName() | String | 设备名称 |
| getIcon() | String | 否 | 设备图标 |
| getProductId() | String | 产品ID |
| getCategory() | String | 设备分类 |
| getTimezoneId() | String | 设备时区ID |
| isCloudOnline | Boolean | 设备是否在云端在线 |
| isLocalOnline | Boolean | 设备是否在本地在线 |
| isOnline | Boolean | 设备是否在线 |
| getLatitude()| String | 设备所在纬度 |
| getLongitude() | String | 设备所在经度 |
| getDps() | Map<String, Any> | 设备数据点 |
| publishDps(dps: DpCommand, callback: IndustryCallBack) | \ | DP控制 |
| getSchemas() | Map<String, DpSchema> | 设备数据点模式 |
| addDeviceListener(listener: IDeviceListener) | \ | 设备监听 |
| removeDeviceListener(listener: IDeviceListener) | \ | 移除设备监听 |
| getWifiSignalStrength(callback: IndustryValueCallBack<String>) | \ | 获取WiFi信号强度 |
| getDevAttribute() | Long | 设备标志位 |
| newOtaManager() | IDeviceOtaManager | 设备OTA升级 |
| newBackupManager() | IDeviceWifiBackupManager | 设备备用网络，具体支不支持此功能，需要参考`getDevAttribute()`返回的值,bit12支持 |

**代码示例**

```java
DeviceService.load("deviceId", new IndustryValueCallBack<IDevice>() {
            @Override
            public void onSuccess(IDevice iDevice) {
                Log.d(TAG, "onSuccess: ");
                
            }

            @Override
            public void onError(int i, String s) {
                Log.d(TAG, "onError: " + s);

            }
        });
```


## 修改设备名称

**参数说明**

| 参数名 | 类型 | 是否必填 | 说明 |
| --- | --- | --- | --- |
| deviceId | String | 是 | 要重命名的设备ID |
| newName | String | 是 | 设备的新名称 |
| callback | IndustryCallBack | 是 | 重命名设备后的回调函数 |

**代码示例**

```java
DeviceService.rename("deviceId", "newName", new IndustryCallBack() {
            @Override
            public void onSuccess() {
                Log.d(TAG, "onSuccess: ");
            }

            @Override
            public void onError(int i, String s) {
                Log.d(TAG, "onError: " + s);

            }
        });
```

## 删除设备

**参数说明**

| 参数名 | 类型 | 是否必填 | 说明 |
| --- | --- | --- | --- |
| deviceId | String | 是 | 要删除的设备ID |
| callback | IndustryCallBack | 是 | 删除设备后的回调函数 |

**代码示例**

```java
DeviceService.remove("deviceId", new IndustryCallBack() {
            @Override
            public void onSuccess() {
                Log.d(TAG, "onSuccess: ");
            }

            @Override
            public void onError(int i, String s) {
                Log.d(TAG, "onError: " + s);

            }
        });
```

## 恢复出厂设置

**参数说明**

| 参数名 | 类型 | 是否必填 | 说明 |
| --- | --- | --- | --- |
| deviceId | String | 是 | 设备ID |
| callback | IndustryCallBack | 是 | 回调函数 |

**代码示例**

```java
DeviceService.resetFactory("deviceId", new IndustryCallBack() {
            @Override
            public void onSuccess() {
                Log.d(TAG, "onSuccess: ");
            }

            @Override
            public void onError(int i, String s) {
                Log.d(TAG, "onError: " + s);

            }
        });
```

## 监听设备

用于监听设备状态的协议。

### 注册设备监听

`IDevice` 提供设备相关信息的监听，包含：

- DP 数据
- 设备名称
- 设备在线状态
- ...

**参数说明**

| 参数| 说明|
| ---- | --- |
| listener | 设备状态监听 |

**代码示例**
```java
iDevice.addDeviceListener(new IDeviceListener() {
                    @Override
                    public void onDpUpdate(String s, String s1) {
                        Log.d(TAG, "onDpUpdate: ");
                    }

                    @Override
                    public void onRemoved(String s) {
                        Log.d(TAG, "onRemoved: ");
                    }

                    @Override
                    public void onStatusChanged(String s, boolean b) {
                        Log.d(TAG, "onStatusChanged: ");
                    }

                    @Override
                    public void onNetworkStatusChanged(String s, boolean b) {
                        Log.d(TAG, "onNetworkStatusChanged: ");
                    }

                    @Override
                    public void onDevInfoUpdate(String s) {

                    }
                });
```

### 取消设备监听

**参数说明**

| 参数| 说明|
| ---- | --- |
| listener | 取消设备状态监听 |

**代码示例**
```java
iDevice.removeDeviceListener(new IDeviceListener() {
                    @Override
                    public void onDpUpdate(String s, String s1) {
                        Log.d(TAG, "onDpUpdate: ");
                    }

                    @Override
                    public void onRemoved(String s) {
                        Log.d(TAG, "onRemoved: ");
                    }

                    @Override
                    public void onStatusChanged(String s, boolean b) {
                        Log.d(TAG, "onStatusChanged: ");
                    }

                    @Override
                    public void onNetworkStatusChanged(String s, boolean b) {
                        Log.d(TAG, "onNetworkStatusChanged: ");
                    }

                    @Override
                    public void onDevInfoUpdate(String s) {

                    }
                });
```

## OTA固件升级

`IDeviceOtaManager`提供了设备固件OTA升级相关方法。包括获取设备固件升级信息，开始升级，取消升级，注册固件升级监听等。

### 获取设备固件升级信息

```java
iDevice.newOtaManager().fetchFirmwareUpgradeInfo(new IndustryDataCallBack<List<FirmwareUpgradeInfo>>() {
                    @Override
                    public void onSuccess(List<FirmwareUpgradeInfo> firmwareUpgradeInfos) {
                        Log.d(TAG, "onSuccess: ");
                    }

                    @Override
                    public void onFailure(String s, String s1) {
                        Log.d(TAG, "onFailure: ");
                    }
                });
```
**`FirmwareUpgradeInfo`对象参数说明**

| 参数名             | 类型     | 说明                                               |
| ------------------ | -------- | -------------------------------------------------- |
| desc               | String   | 升级文案                                           |
| upgradeStatus      | Int      | 升级状态 <ul><li>`0`：无新版本 </li><li>`1`：有新版本 </li><li>`2`：在升级中 </li><li>`5`：等待设备唤醒</li></ul>                                             |
| version            | String   | 新版本使用的固件版本                               |
| currentVersion     | String   | 当前的固件版本                                     |
| timeout            | Int      | 超时时间                                           |
| upgradeType        | Int      | 升级类型  <ul><li>`0`：App 提醒升级 </li><li>`2`：App 强制升级 </li><li>`3`：检测升级</li></ul>                                          |
| type               | Int      | 固件通道类型     <ul><li>普通固件使用 0：主联网模块、Wi-Fi 模块、蓝牙模块</li><li>1：蓝牙模块</li><li>2：GPRS 模块</li><li>3：Zigbee 模块</li><li>5：433 模块</li><li>6：NB-IoT 模块</li><li>9：MCU 模块</li><li>10~19：扩展通道 </li></ul>   |
| typeDesc           | String   | 固件通道描述                                       |
| lastUpgradeTime    | Long     | 上次升级时间                                       |
| firmwareDeployTime | Long     | 固件部署时间                                       |
| fileSize           | Long     | 固件包的大小，单位：字节                           |
| controlType        | Int      | 升级中是否可控制  <ul><li>`YES`：升级中可控制 </li><li>`NO`：升级中不可控制</li></ul>                                 |
| upgradingDesc      | String   | 固件升级中的提示文案                               |
| downloadingDesc    | String   | 下载中的提示文案                                   |
| remind             | String   | 前置校验规则未通过的提示文案                       |
| canUpgrade         | Boolean? | 前置校验规则是否通过 <ul><li> null: 无前置校验规则，可直接升级 </li><li>  false: 有前置校验，不可升级，建议展示 `remind` 文案  </li><li>  true: 有前置校验，可以升级 </li></ul>      |
| devType            | Int      | 设备类型 <ul><li>`0`：普通设备 </li><li>`1`：低功耗类型设备</li></ul>                                          |
| waitingDesc        | String   | 固件等待设备唤醒的文案                             |
| upgradeMode        | Int      | 固件类别  v3.35.5 开始支持<br /><ul><li> 0: 普通固件 </li><li>  1: PID 版本升级固件 </li></ul>                                         |


### 开始升级

**参数说明**

| 参数名 | 类型 | 说明 |
| --- | --- | --- |
| upgradeInfoList | List<FirmwareUpgradeInfo> | 设备固件升级信息 |

**示例代码**

```java
iDevice.newOtaManager().startOTA(upgradeInfoList);
```


### 继续升级

**参数说明**

| 参数名 | 类型 | 说明 |
| --- | --- | --- |
| isContinue | Boolean | 是否继续 |

**示例代码**

```java
iDevice.newOtaManager().continueOTA(isContinue)
```


### 取消升级

**参数说明**

| 参数名 | 类型 | 说明 |
| --- | --- | --- |
| firmwareType | Int | 固件类型 |
| callback | IndustryNormalCallback | 回调 |

**代码示例**

```java
iDevice.newOtaManager().cancelOTA(0, new IndustryNormalCallback() {
                    @Override
                    public void onSuccess() {
                        Log.d(TAG, "onSuccess: ");
                    }

                    @Override
                    public void onFailure(String s, String s1) {
                        Log.d(TAG, "onFailure: ");
                    }
                });
```

### 获取设备固件升级状态。

**代码示例**

```java
iDevice.newOtaManager().fetchUpgradingInfo(new IndustryDataCallBack<DeviceUpgradeStatusBean>() {
                    @Override
                    public void onSuccess(DeviceUpgradeStatusBean deviceUpgradeStatusBean) {
                        Log.d(TAG, "onSuccess: ");
                    }

                    @Override
                    public void onFailure(String s, String s1) {
                        Log.d(TAG, "onFailure: ");
                    }
                });
```

**`DeviceUpgradeStatusBean`参数说明**

| 参数名           | 类型                 | 说明                                                         |
| --------------- | -------------------- | ------------------------------------------------------------ |
| devId           | String               | 设备 ID                                                       |
| firmwareType    | int                  | 固件类型                                                     |
| statusText      | String               | 状态描述                                                     |
| statusTitle     | String               | 状态标题                                                     |
| progress        | int                  | 进度，部分情况下，参数值可能小于 0，请忽略此种小于 0 的进度                         |
| status          | DevUpgradeStatusEnum | 升级状态枚举<br /><ul><li> `2`：在升级中 </li><li> `3`：升级成功 </li><li> `4`：升级失败 </li><li> `5`：等待设备唤醒 </li><li> `6`：设备已下载固件 </li><li> `7`：升级超时 </li><li> `100`：App 正在准备中（比如：正在连接蓝牙设备、App 正在下载固件包） </li></ul> |
| upgradeMode | Int      | <ul><li>`0`：普通固件 </li><li>`1`：PID 版本升级，v3.35.5 开始支持             |
| errorMsg        | String               | 失败信息                                                     |
| errorCode | Int | 失败错误码 |


### 回调监听

**示例代码**

```java
iDevice.newOtaManager().registerOTAListener(new IDeviceOtaListener() {
                    @Override
                    public void firmwareUpgradeStatus(DeviceUpgradeStatusBean deviceUpgradeStatusBean) {
                        Log.d(TAG, "firmwareUpgradeStatus: ");
                    }
                });
```


## 设备控制

**参数说明**

| 参数名 | 类型 | 是否必填 | 说明 |
| --- | --- | --- | --- |
| dpCommand | DpCommand | 是 | 数据点命令 |
| callback | IndustryCallBack | 是 | 成功回调函数 |

**`DpCommand`数据说明：**

| 参数名 | 类型 | 是否必填 | 说明 |
| --- | --- | --- | --- |
| publishMode | DpsPublishMode | 是 | 数据下发方式 |
| dps | List<Dp> | 是 | DP 数据集 |

**创建`dpCommand`示例**

```java
DpCommand dpCommand = new DpCommand.Builder()
                        .addDp("key","value")
                        .publishMode(DpsPublishMode.AUTO)
                        .build();
```

**代码示例**

```java
iDevice.publishDps(dpCommand, new IndustryCallBack() {
                    @Override
                    public void onSuccess() {
                        Log.d(TAG, "onSuccess: ");
                    }

                    @Override
                    public void onError(int i, String s) {
                        Log.d(TAG, "onError: ");

                    }
                });
```

## 备用网络

:::important
请通过 `iDevice.getDevAttribute() & (1 << 12)` 判断当前设备是否支持设置备用网络，`1` 表示支持，`0` 表示不支持。
:::

### 查询设备连接的 Wi-Fi 信息

**参数说明**
| 参数名 | 类型 | 是否必填 | 说明 |
| --- | --- | --- | --- |
| callback | IndustryDataCallBack | 是 |回调 |

**`ConnectWifiInfoBean`数据对象说明**

**参数说明**

| 参数名   | 类型   | 说明                         |
| -------- | ------ | ---------------------------- |
| devId    | String | 设备Id                       |
| tId      | String | 消息Id                       |
| ssid     | String | Wi-Fi SSID                   |
| signal   | Int    | Wi-Fi 信号强度               |
| network  | Int    | 网络状态                     |
| version  | Int    | 当前协议版本                 |
| hash     | String | 当前 Wi-Fi 的哈希值          |


**代码示例**
```java
iDevice.newBackupManager().fetchConnectWifiInfo(new IndustryDataCallBack<ConnectWifiInfoBean>() {
                    @Override
                    public void onSuccess(ConnectWifiInfoBean connectWifiInfoBean) {
                        Log.d(TAG, "onSuccess: ");
                    }

                    @Override
                    public void onFailure(String s, String s1) {
                        Log.d(TAG, "onFailure: ");
                    }
                });
```

### 查询设备的备用 Wi-Fi 列表

**`BackupWifiInfoListBean`数据对象说明**

 **参数说明**

| 参数名       | 类型                     | 说明                                     |
| ------------ | ------------------------ | ---------------------------------------- |
| devId        | String                   | 设备Id                                   |
| tId          | String                   | 消息Id                                   |
| maxNum       | String                   | 设备可以存储的最大 SSID 数量              |
| backupList   | MutableList<BackupWifiInfoBean> | 备份的 Wi-Fi 网络信息列表，类型为 [BackupWifiInfoBean] |

**`BackupWifiInfoBean`参数说明**

| 参数名  | 类型   | 说明                                              |
| ------- | ------ | ------------------------------------------------- |
| ssid    | String | Wi-Fi SSID                                        |
| hash    | String | Wi-Fi 密码哈希值                                  |
| passwd  | String | Wi-Fi 密码                                        |


**代码示例**
```java
iDevice.newBackupManager().fetchBackupWifiInfoList(new IndustryDataCallBack<BackupWifiInfoListBean>() {
                    @Override
                    public void onSuccess(BackupWifiInfoListBean backupWifiInfoListBean) {
                        Log.d(TAG, "onSuccess: ");
                        
                    }

                    @Override
                    public void onFailure(String s, String s1) {
                        Log.d(TAG, "onFailure: ");

                    }
                });
```

### 设置备用网络列表

**参数说明**

| 参数 | 描述 |
| ---- | ---- |
| backupWifiList | 备用 Wi-Fi 信息 Bean |
| callback | 回调 |

**`BackupWifiResultBean`数据模型说明**

**参数说明**

| 参数名    | 类型                     | 说明                   |
| --------- | ------------------------ | ---------------------- |
| devId     | String                   | 设备ID                 |
| tId       | String                   | 消息ID                 |
| ssid      | String                   | Wi-Fi SSID             |
| resCode   | Int                      | 设备响应代码           |
| ssidList  | MutableList<String>      | Wi-Fi SSID 列表        |


**示例代码**
```java
ArrayList<BackupWifiInfoBean> backupWifiList = new ArrayList<>();
                // 新添加的，设置密码
                BackupWifiInfoBean backupWifiBean = new BackupWifiInfoBean();
                backupWifiBean.setSsid("test1");
                backupWifiBean.setPasswd("12345678");
                backupWifiList.add(backupWifiBean);

                iDevice.newBackupManager().setBackupWifiInfoList(backupWifiList, new IndustryDataCallBack<BackupWifiResultBean>() {
                    @Override
                    public void onSuccess(BackupWifiResultBean backupWifiResultBean) {
                        Log.d(TAG, "onSuccess: ");
                    }

                    @Override
                    public void onFailure(String s, String s1) {
                        Log.d(TAG, "onFailure: ");
                    }
                });
```

### 切换到新 Wi-Fi

**参数说明**

| 参数 |类型| 说明 |
| ---- | ---- | ---- |
| ssid | String | Wi-Fi 名称 |
| password | String |  Wi-Fi 密码 |
| callback | IndustryDataCallBack |  回调 |

**示例代码**
```java
iDevice.newBackupManager().switchToTargetWifi("ssid", "password", new IndustryDataCallBack<SwitchWifiResultBean>() {
                    @Override
                    public void onSuccess(SwitchWifiResultBean switchWifiResultBean) {
                        Log.d(TAG, "onSuccess: ");
                    }

                    @Override
                    public void onFailure(String s, String s1) {
                        Log.d(TAG, "onFailure: ");

                    }
                });
```
### 切换到已备份的 Wi-Fi

**参数说明**

| 参数 |类型| 说明 |
| ---- | ---- | ---- |
| hash | String | Wi-Fi 密码的Hash值 |
| callback | IndustryDataCallBack |  回调 |

**示例代码**
```java
iDevice.newBackupManager().switchToBackupWifi("hash", new IndustryDataCallBack<SwitchWifiResultBean>() {
                    @Override
                    public void onSuccess(SwitchWifiResultBean switchWifiResultBean) {
                        Log.d(TAG, "onSuccess: ");
                    }

                    @Override
                    public void onFailure(String s, String s1) {
                        Log.d(TAG, "onFailure: ");
                    }
                });
```

### 退出页面销毁监听

**接口说明**

```java
iDevice.newBackupManager().onDestroy();
```

